(function(){"use strict";var inNodeJS=false;if(typeof process!=="undefined"&&!process.browser){inNodeJS=true;var request=require("request".trim())}var supportsCORS=false;var inLegacyIE=false;try{var testXHR=new XMLHttpRequest;if(typeof testXHR.withCredentials!=="undefined"){supportsCORS=true}else{if("XDomainRequest"in window){supportsCORS=true;inLegacyIE=true}}}catch(e){}var indexOfProto=Array.prototype.indexOf;var ttIndexOf=function(array,item){var i=0,l=array.length;if(indexOfProto&&array.indexOf===indexOfProto)return array.indexOf(item);for(;i<l;i++)if(array[i]===item)return i;return-1};var Tabletop=function(options){if(!this||!(this instanceof Tabletop)){return new Tabletop(options)}if(typeof options==="string"){options={key:options}}this.callback=options.callback;this.wanted=options.wanted||[];this.key=options.key;this.simpleSheet=!!options.simpleSheet;this.parseNumbers=!!options.parseNumbers;this.wait=!!options.wait;this.reverse=!!options.reverse;this.postProcess=options.postProcess;this.debug=!!options.debug;this.query=options.query||"";this.orderby=options.orderby;this.endpoint=options.endpoint||"https://spreadsheets.google.com";this.singleton=!!options.singleton;this.simple_url=!!options.simple_url;this.callbackContext=options.callbackContext;this.prettyColumnNames=typeof options.prettyColumnNames=="undefined"?!options.proxy:options.prettyColumnNames;if(typeof options.proxy!=="undefined"){this.endpoint=options.proxy.replace(/\/$/,"");this.simple_url=true;this.singleton=true;supportsCORS=false}this.parameterize=options.parameterize||false;if(this.singleton){if(typeof Tabletop.singleton!=="undefined"){this.log("WARNING! Tabletop singleton already defined")}Tabletop.singleton=this}if(/key=/.test(this.key)){this.log("You passed an old Google Docs url as the key! Attempting to parse.");this.key=this.key.match("key=(.*?)(&|#|$)")[1]}if(/pubhtml/.test(this.key)){this.log("You passed a new Google Spreadsheets url as the key! Attempting to parse.");this.key=this.key.match("d\\/(.*?)\\/pubhtml")[1]}if(!this.key){this.log("You need to pass Tabletop a key!");return}this.log("Initializing with key "+this.key);this.models={};this.model_names=[];this.base_json_path="/feeds/worksheets/"+this.key+"/public/basic?alt=";if(inNodeJS||supportsCORS){this.base_json_path+="json"}else{this.base_json_path+="json-in-script"}if(!this.wait){this.fetch()}};Tabletop.callbacks={};Tabletop.init=function(options){return new Tabletop(options)};Tabletop.sheets=function(){this.log("Times have changed! You'll want to use var tabletop = Tabletop.init(...); tabletop.sheets(...); instead of Tabletop.sheets(...)")};Tabletop.prototype={fetch:function(callback){if(typeof callback!=="undefined"){this.callback=callback}this.requestData(this.base_json_path,this.loadSheets)},requestData:function(path,callback){if(inNodeJS){this.serverSideFetch(path,callback)}else{var protocol=this.endpoint.split("//").shift()||"http";if(supportsCORS&&(!inLegacyIE||protocol===location.protocol)){this.xhrFetch(path,callback)}else{this.injectScript(path,callback)}}},xhrFetch:function(path,callback){var xhr=inLegacyIE?new XDomainRequest:new XMLHttpRequest;xhr.open("GET",this.endpoint+path);var self=this;xhr.onload=function(){try{var json=JSON.parse(xhr.responseText)}catch(e){console.error(e)}callback.call(self,json)};xhr.send()},injectScript:function(path,callback){var script=document.createElement("script");var callbackName;if(this.singleton){if(callback===this.loadSheets){callbackName="Tabletop.singleton.loadSheets"}else if(callback===this.loadSheet){callbackName="Tabletop.singleton.loadSheet"}}else{var self=this;callbackName="tt"+ +new Date+Math.floor(Math.random()*1e5);Tabletop.callbacks[callbackName]=function(){var args=Array.prototype.slice.call(arguments,0);callback.apply(self,args);script.parentNode.removeChild(script);delete Tabletop.callbacks[callbackName]};callbackName="Tabletop.callbacks."+callbackName}var url=path+"&callback="+callbackName;if(this.simple_url){if(path.indexOf("/list/")!==-1){script.src=this.endpoint+"/"+this.key+"-"+path.split("/")[4]}else{script.src=this.endpoint+"/"+this.key}}else{script.src=this.endpoint+url}if(this.parameterize){script.src=this.parameterize+encodeURIComponent(script.src)}document.getElementsByTagName("script")[0].parentNode.appendChild(script)},serverSideFetch:function(path,callback){var self=this;request({url:this.endpoint+path,json:true},function(err,resp,body){if(err){return console.error(err)}callback.call(self,body)})},isWanted:function(sheetName){if(this.wanted.length===0){return true}else{return ttIndexOf(this.wanted,sheetName)!==-1}},data:function(){if(this.model_names.length===0){return undefined}if(this.simpleSheet){if(this.model_names.length>1&&this.debug){this.log("WARNING You have more than one sheet but are using simple sheet mode! Don't blame me when something goes wrong.")}return this.models[this.model_names[0]].all()}else{return this.models}},addWanted:function(sheet){if(ttIndexOf(this.wanted,sheet)===-1){this.wanted.push(sheet)}},loadSheets:function(data){var i,ilen;var toLoad=[];this.googleSheetName=data.feed.title.$t;this.foundSheetNames=[];for(i=0,ilen=data.feed.entry.length;i<ilen;i++){this.foundSheetNames.push(data.feed.entry[i].title.$t);if(this.isWanted(data.feed.entry[i].content.$t)){var linkIdx=data.feed.entry[i].link.length-1;var sheet_id=data.feed.entry[i].link[linkIdx].href.split("/").pop();var json_path="/feeds/list/"+this.key+"/"+sheet_id+"/public/values?alt=";if(inNodeJS||supportsCORS){json_path+="json"}else{json_path+="json-in-script"}if(this.query){json_path+="&sq="+this.query}if(this.orderby){json_path+="&orderby=column:"+this.orderby.toLowerCase()}if(this.reverse){json_path+="&reverse=true"}toLoad.push(json_path)}}this.sheetsToLoad=toLoad.length;for(i=0,ilen=toLoad.length;i<ilen;i++){this.requestData(toLoad[i],this.loadSheet)}},sheets:function(sheetName){if(typeof sheetName==="undefined"){return this.models}else{if(typeof this.models[sheetName]==="undefined"){return}else{return this.models[sheetName]}}},sheetReady:function(model){this.models[model.name]=model;if(ttIndexOf(this.model_names,model.name)===-1){this.model_names.push(model.name)}this.sheetsToLoad--;if(this.sheetsToLoad===0)this.doCallback()},loadSheet:function(data){var that=this;var model=new Tabletop.Model({data:data,parseNumbers:this.parseNumbers,postProcess:this.postProcess,tabletop:this,prettyColumnNames:this.prettyColumnNames,onReady:function(){that.sheetReady(this)}})},doCallback:function(){if(this.sheetsToLoad===0){this.callback.apply(this.callbackContext||this,[this.data(),this])}},log:function(msg){if(this.debug){if(typeof console!=="undefined"&&typeof console.log!=="undefined"){Function.prototype.apply.apply(console.log,[console,arguments])}}}};Tabletop.Model=function(options){var i,j,ilen,jlen;this.column_names=[];this.name=options.data.feed.title.$t;this.tabletop=options.tabletop;this.elements=[];this.onReady=options.onReady;this.raw=options.data;if(typeof options.data.feed.entry==="undefined"){options.tabletop.log("Missing data for "+this.name+", make sure you didn't forget column headers");this.original_columns=[];this.elements=[];this.onReady.call(this);return}for(var key in options.data.feed.entry[0]){if(/^gsx/.test(key))this.column_names.push(key.replace("gsx$",""))}this.original_columns=this.column_names;for(i=0,ilen=options.data.feed.entry.length;i<ilen;i++){var source=options.data.feed.entry[i];var element={};for(var j=0,jlen=this.column_names.length;j<jlen;j++){var cell=source["gsx$"+this.column_names[j]];if(typeof cell!=="undefined"){if(options.parseNumbers&&cell.$t!==""&&!isNaN(cell.$t))element[this.column_names[j]]=+cell.$t;else element[this.column_names[j]]=cell.$t}else{element[this.column_names[j]]=""}}if(element.rowNumber===undefined)element.rowNumber=i+1;if(options.postProcess)options.postProcess(element);this.elements.push(element)}if(options.prettyColumnNames)this.fetchPrettyColumns();else this.onReady.call(this)};Tabletop.Model.prototype={all:function(){return this.elements},fetchPrettyColumns:function(){if(!this.raw.feed.link[3])return this.ready();var cellurl=this.raw.feed.link[3].href.replace("/feeds/list/","/feeds/cells/").replace("https://spreadsheets.google.com","");var that=this;this.tabletop.requestData(cellurl,function(data){that.loadPrettyColumns(data)})},ready:function(){this.onReady.call(this)},loadPrettyColumns:function(data){var pretty_columns={};var column_names=this.column_names;var i=0;var l=column_names.length;for(;i<l;i++){if(typeof data.feed.entry[i].content.$t!=="undefined"){pretty_columns[column_names[i]]=data.feed.entry[i].content.$t}else{pretty_columns[column_names[i]]=column_names[i]}}this.pretty_columns=pretty_columns;this.prettifyElements();this.ready()},prettifyElements:function(){var pretty_elements=[],ordered_pretty_names=[],i,j,ilen,jlen;var ordered_pretty_names;for(j=0,jlen=this.column_names.length;j<jlen;j++){ordered_pretty_names.push(this.pretty_columns[this.column_names[j]])}for(i=0,ilen=this.elements.length;i<ilen;i++){var new_element={};for(j=0,jlen=this.column_names.length;j<jlen;j++){var new_column_name=this.pretty_columns[this.column_names[j]];new_element[new_column_name]=this.elements[i][this.column_names[j]]}pretty_elements.push(new_element)}this.elements=pretty_elements;this.column_names=ordered_pretty_names},toArray:function(){var array=[],i,j,ilen,jlen;for(i=0,ilen=this.elements.length;i<ilen;i++){var row=[];for(j=0,jlen=this.column_names.length;j<jlen;j++){row.push(this.elements[i][this.column_names[j]])}array.push(row)}return array}};if(typeof module!=="undefined"&&module.exports){module.exports=Tabletop}else if(typeof define==="function"&&define.amd){define(function(){return Tabletop})}else{window.Tabletop=Tabletop}})();